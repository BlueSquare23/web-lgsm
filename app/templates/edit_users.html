{% extends "base.html" %}
{% block title %}Edit or Create User(s){% endblock %}

{% block content %}
      <br />
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-md-8 col-lg-8">
            <div class="card bg-dark border border-white rounded">
              <div class="card-header">
                <h3 class="mb-0">Create or Edit Web LGSM User(s)</h3>
              </div>
              <div class="card-body bg-dark">
                <h4 align="enter" style="color: white;">
                  Select User:
                </h4>
                <ul class="list-group">
                  {% if selected_user == 'newuser' %}
                  <a href="/edit_users?username=newuser" class="list-group-item list-group-item-action text-decoration-none border border-white active" aria-current="true">New User</a>
                  {% else %}
                  <a href="/edit_users?username=newuser" class="list-group-item list-group-item-action text-decoration-none border border-white">New User</a>
                  {% endif %}

                  {% for user in all_users if user.id != 1 %}
                    {% if user.username == selected_user %}
                  <a href="/edit_users?username={{user.username}}" class="list-group-item list-group-item-action text-decoration-none border border-white active" aria-current="true">{{user.username}}</a>
                    {% else %}
                  <a href="/edit_users?username={{user.username}}" class="list-group-item list-group-item-action text-decoration-none border border-white">{{user.username}}</a>
                    {% endif %}
                  {% endfor %}
                </ul>
                <br/>

                {% if selected_user is not none %}
                <h4 align="enter" style="color: white;">
                  User Settings:
                </h4>
                <form method="POST" id="userForm">
                  {{ form.csrf_token }}
                  <div class="form-group" style="color: white;">
                    <input type="hidden" id="selected_user" name="selected_user" value="{{ selected_user }}">
                      
                    {% if selected_user == 'newuser' %}
                    <div id="user_pass_fields">
                    {% else %}
                    <div class="form-check form-switch">
                      {{ form.change_username_password(class="form-check-input", onchange="toggleViewUserPassFields()") }}
                      {{ form.change_username_password.label(class="form-check-label") }}
                    </div>
                    <div id="user_pass_fields" class="d-none">
                    {% endif %}

                      <div class="form-group mb-3">
                        {{ form.username.label(class="text-white") }}
                        {% if selected_user == 'newuser' %}
                        {{ form.username(class="form-control", placeholder="Enter New Username") }}
                        {% else %}
                        {{ form.username(class="form-control", value=selected_user, placeholder=selected_user) }}
                        {% endif %}
                      </div>
                      
                      <div class="form-group mb-1">
                        {{ form.password1.label(class="text-white") }}
                        <div class="password-container">
                          {{ form.password1() }}
                          <span class="password-toggle" id="togglePassword1">
                            <i class="bi bi-eye text-white"></i>
                          </span>
                        </div>
                      </div>
                      
                      <div class="form-group mb-3">
                        {{ form.password2.label() }}
                        <div class="password-container">
                          {{ form.password2() }}
                          <span class="password-toggle" id="togglePassword2">
                            <i class="bi bi-eye text-white"></i>
                          </span>
                        </div>
                        <div class="invalid-feedback" id="confirmPasswordFeedback"></div>
                      </div>

                      <!-- Password Strength Meter -->
                      <div class="mb-3">
                        <div class="progress" id="passwordStrengthBar">
                          <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="password-feedback" id="passwordFeedback"></div>
                      </div>
                      
                      <!-- Password Requirements -->
                      <div class="alert alert-primary">
                        <small>
                          <i class="bi bi-info-circle"></i> 
                          Passwords must meet the following requirements:
                        </small>
                        <ul class="requirement-list">
                          <li id="reqLength" class="invalid-requirement"><i class="bi bi-x-circle-fill"></i> At least 12 characters long</li>
                          <li id="reqDigit" class="invalid-requirement"><i class="bi bi-x-circle-fill"></i> 1 number [0-9]</li>
                          <li id="reqUppercase" class="invalid-requirement"><i class="bi bi-x-circle-fill"></i> 1 uppercase letter</li>
                          <li id="reqLowercase" class="invalid-requirement"><i class="bi bi-x-circle-fill"></i> 1 lowercase letter</li>
                          <li id="reqSpecial" class="invalid-requirement"><i class="bi bi-x-circle-fill"></i> 1 special character</li>
                        </ul>
                      </div>
                    </div>

                    <div id="two_factor" class="mb-4">
                      <div class="form-check form-switch">
                          {{ form.enable_otp(class="form-check-input", checked=user_otp_enabled) }}
                          {{ form.enable_otp.label(class="form-check-label text-white") }}
                      </div>
                      <small class="text-white-50">
                        <i class="bi bi-info-circle"></i> 
                         User will be prompted to setup Two Factor Auth using OTP codes upon first login
                      </small>
                    </div>

                    <hr>

                    <!-- Admin radio buttons -->
                    {{ form.is_admin.label(class="form-label") }}
                    {% for subfield in form.is_admin %}
                        <div class="form-check">
                            {{ subfield(id="is_admin", class="form-check-input", onchange="togglePermissions()") }}
                            {{ subfield.label(class="form-check-label") }}
                        </div>
                    {% endfor %}
      
                    <br />

                    <div class="container">
                      <div class="row">
                        <!-- Non-admin permissions, disabled if Admin is checked -->
                        <div id="non-admin-permissions">
                          <label><i><u>Basic Permissions</u></i></label><br />
      
                          {{ form.install(class="form-check-input") }}
                          {{ form.install.label }}<br />
      
                          {{ form.add(class="form-check-input") }}
                          {{ form.add.label }}<br />
      
                          {{ form.settings(class="form-check-input") }}
                          {{ form.settings.label }}<br />
      
                          {{ form.edit(class="form-check-input") }}
                          {{ form.edit.label }}<br />

                          {{ form.jobs(class="form-check-input") }}
                          {{ form.jobs.label }}<br />
      
                          {{ form.delete(class="form-check-input") }}
                          {{ form.delete.label }}<br />
                          <br />
      
                          <label><i><u>Allowed Controls</u></i></label><br />
                          <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="toggleAllControls()">All Controls</button>
      
                          <div class="form-check">
                            {% for control in controls %}
                              <input class="form-check-input control-checkbox" type="checkbox" 
                                     id="control_{{ loop.index }}" name="controls" 
                                     value="{{ control }}">
                              <label class="form-check-label" for="control_{{ loop.index }}">{{ control }}</label><br />
                            {% endfor %}
                          </div>
      
                          <br />
      
                          <label><i><u>Allow Access to Game Servers</u></i></label><br />
                          {% if installed_servers | length > 0 %}
                          <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="toggleAllGameServers()">All Game Servers</button>
                          <div class="form-check">
                            {% for server in installed_servers %}
                              <input class="form-check-input gameserver-checkbox" type="checkbox" 
                                     id="server_{{ server.id }}" name="server_ids" 
                                     value="{{ server.id }}">
                              <label class="form-check-label" for="server_{{ server.id }}">{{ server.install_name }}</label><br />
                            {% endfor %}
                          </div>
                          {% else %}
                          <p>No game servers installed yet!<br/>
                          You can adjust what servers this user has access to after installing or adding a game server.</p>
                          {% endif %}
                        </div>
      
                        <br />
                      </div>
                    </div>
                    <div class="floating-submit">
                      <button class="btn btn-outline-primary" type="submit">Submit</button>
                    </div>
                  </div>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <script src="static/js/password-strength.js"></script>

      {% if selected_user != 'newuser' %}
      <a id="delete-btn" title="Perminantly delete web-lgsm user" onclick="return confirm('Are you sure you want to delete {{selected_user}}?');" class="btn btn-outline-danger" href="/edit_users?username={{selected_user}}&delete=true" role="button">
        Delete {{selected_user}}
      </a>
      {% endif %}

      <script>
        const userRole = '{{user_role}}';
        const userPerms = JSON.parse({{user_permissions | tojson}});
      </script>
      <script src="/static/js/edit_user.js"></script>

{% endblock %}
