{% extends "base.html" %}
{% block title %}Web LGSM Jobs{% endblock %}

{% block content %}

        {% set parsed_json = user.permissions|from_json %}
        <br>
        {% include 'spinners.html' %}

        <br />
        <h2>Web-LGSM Job Scheduler</h2>
        <hr />

        <h3>Game Servers:</h3>
        <hr />
        {% for server in game_servers %}
          <div class="list-group-item rounded">
            <div class="d-flex align-items-center">
              <a href="/jobs?server_id={{server.id}}" class="game_server_link text-decoration-none flex-grow-1">
                  <span>{{server.install_name}}</span>
              </a>
            </div>
          </div>
        {% endfor %}

        {% if selected_server %}
          <div class="container mt-4">
          <br />
          <h3>Cron Jobs:</h3>
          <hr />
          <div class="card mb-4 rounded border-secondary">
            <div class="card-body bg-dark d-flex justify-content-center">
              <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCronModal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                </svg>
                Add New Cron Job
              </button>
            </div>
          </div>
          <div class="list-group">
            {% for job in jobs_list %}
            <div class="job-item list-group-item rounded border-secondary">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">{{ job.command }}</h5>
                <small class="text-muted">Job ID: {{ job.job_id }}</small>
              </div>

              <p class="mb-1">
                <span class="badge bg-info text-dark">{{ job.schedule }}</span>
                <span class="cron-human-readable ms-2" data-cron="{{ job.schedule }}"></span>
              </p>

              <div class="mt-2">
                <button class="btn btn-sm btn-outline-secondary edit-cron" data-uuid="{{ job.server_id }}" data-uid="{{ job.job_id}}">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger delete-cron" data-uuid="{{ job.server_id }}" data-uid="{{ job.job_id }}">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Add Cron Modal -->
        <div class="modal fade" id="addCronModal" tabindex="-1" aria-labelledby="addCronModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
              <div class="modal-header bg-dark border-secondary">
                <h5 class="modal-title" id="addCronModalLabel">Cron Job Editor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body bg-dark">
                <form id="cronForm" method="POST" action="/jobs">
                  {{ form.csrf_token }}
                  {{ form.server_id(value=selected_server) }}
                  {{ form.job_id() }}

                  <div class="mb-3">
                    <div class="row">
                      <div class="col">
                        <label class="form-label">Command</label>
                        {{ form.command(class="form-select bg-dark text-light border-secondary") }}
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col">
                        <label class="form-label">Comment</label>
                        {{ form.comment(class="form-control bg-dark text-light border-secondary") }}
                      </div>
                    </div>
                  </div>

                  <div class="card mb-3 bg-dark border-secondary">
                    <div class="card-header bg-dark border-secondary">Schedule</div>
                    <div class="card-body bg-dark">
                      <div class="row mb-3">
                        <div class="col">
                          <label class="form-label">Minutes</label>
                          <input type="text" class="form-control bg-dark text-light border-secondary" id="minutes" value="*" placeholder="*">
                        </div>
                        <div class="col">
                          <label class="form-label">Hours</label>
                          <input type="text" class="form-control bg-dark text-light border-secondary" id="hours" value="*" placeholder="*">
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col">
                          <label class="form-label">Day of Month</label>
                          <input type="text" class="form-control bg-dark text-light border-secondary" id="dayOfMonth" value="*" placeholder="*">
                        </div>
                        <div class="col">
                          <label class="form-label">Month</label>
                          <select class="form-select bg-dark text-light border-secondary" id="month">
                            <option value="*">Every Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                          </select>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col">
                          <label class="form-label">Day of Week</label>
                          <select class="form-select bg-dark text-light border-secondary" id="dayOfWeek">
                            <option value="*">Every Day</option>
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                            <option value="1,2,3,4,5">Weekdays</option>
                            <option value="0,6">Weekends</option>
                          </select>
                        </div>
                      </div>
                      <div class="mt-3">
                        <label class="form-label">Cron Expression (readonly)</label>
                        {{ form.cron_expression(class="form-control bg-dark text-light border-secondary", id="cronExpression") }}
                      </div>
                      <div class="mt-2">
                        <small class="text-muted" id="cronDescription"></small>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer bg-dark border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="cronForm" class="btn btn-outline-primary" id="saveCron">Save Changes</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <script src="/static/js/show-spinners.js"></script>
        <script>
document.addEventListener('DOMContentLoaded', function() {
  // Update cron expression when any field changes
  const cronInputs = ['minutes', 'hours', 'dayOfMonth', 'month', 'dayOfWeek'];
  cronInputs.forEach(id => {
    document.getElementById(id).addEventListener('change', updateCronExpression);
  });
  updateCronExpression();

  // Edit button handlers
  document.querySelectorAll('.edit-cron').forEach(btn => {
    btn.addEventListener('click', function() {
      const server_id = this.getAttribute('data-uuid');
      const job_id = this.getAttribute('data-uid');
      // Fetch job data and populate form
      fetch(`/api/cron/${server_id}/${job_id}`)
        .then(response => response.json())
        .then(job => {
          document.getElementById('server_id').value = job.server_id;
          document.getElementById('job_id').value = job.job_id;
          document.getElementById('comment').value = job.comment;
          document.getElementById('command').value = job.command;
          
          // Parse cron expression
          const parts = job.schedule.split(' ');
          document.getElementById('minutes').value = parts[0];
          document.getElementById('hours').value = parts[1];
          document.getElementById('dayOfMonth').value = parts[2];
          document.getElementById('month').value = parts[3];
          document.getElementById('dayOfWeek').value = parts[4];
          
          updateCronExpression();
          
          // Show modal
          const modal = new bootstrap.Modal(document.getElementById('addCronModal'));
          modal.show();
      });
    });
  });

  // Delete button handlers
  document.querySelectorAll('.delete-cron').forEach(btn => {
    btn.addEventListener('click', handleDeleteCron);
  });
});

function handleDeleteCron() {
  const serverId = this.getAttribute('data-uuid');
  const jobId = this.getAttribute('data-uid');
  
  if (confirm('Are you sure you want to delete this cron job?')) {
    showSpinners();
    window.scrollTo(0,0); 

    fetch(`/api/cron/${serverId}/${jobId}`, {
      method: 'DELETE'
    })
    .then(response => {
      if (response.status === 204) {
        this.closest('.job-item').remove();
        
        showAlert('Cron job deleted successfully', 'success');
        hideSpinners();
      } 
      else if (response.status === 500) {
        throw new Error('Server error while deleting cron job');
      }
      else {
        throw new Error(`Unexpected response status: ${response.status}`);
      }
    })
    .catch(error => {
      console.error('Error deleting cron job:', error);
      showAlert('Failed to delete cron job', 'danger');
      hideSpinners();
    });
  }
}

function updateCronExpression() {
  const minutes = document.getElementById('minutes').value;
  const hours = document.getElementById('hours').value;
  const dayOfMonth = document.getElementById('dayOfMonth').value;
  const month = document.getElementById('month').value;
  const dayOfWeek = document.getElementById('dayOfWeek').value;
  
  const cronExpression = `${minutes} ${hours} ${dayOfMonth} ${month} ${dayOfWeek}`;
  document.getElementById('cronExpression').value = cronExpression;
  
  // Update human-readable description
  document.getElementById('cronDescription').textContent = describeCron(cronExpression);
  
  // Also update all human-readable descriptions in the list
  document.querySelectorAll('.cron-human-readable').forEach(el => {
    el.textContent = describeCron(el.getAttribute('data-cron'));
  });
}

function describeCron(cronExpression) {
  const parts = cronExpression.split(' ');
  if (parts.length !== 5) return 'Invalid cron expression';
  
  const [min, hour, dom, month, dow] = parts;
  
  let description = 'Runs ';
  
  // Handle minutes
  if (min === '*') {
    description += 'every minute ';
  } else {
    description += `at minute ${min} `;
  }
  
  // Handle hours
  if (hour === '*') {
    description += 'of every hour ';
  } else {
    description += `of hour ${hour} `;
  }
  
  // Handle day of month
  if (dom !== '*') {
    description += `on day ${dom} of the month `;
  }
  
  // Handle month
  if (month !== '*') {
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                   'July', 'August', 'September', 'October', 'November', 'December'];
    description += `in ${months[parseInt(month) - 1]} `;
  }
  
  // Handle day of week
  if (dow !== '*') {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    if (dow.includes(',')) {
      const dayNumbers = dow.split(',').map(d => parseInt(d));
      description += 'on ' + dayNumbers.map(d => days[d]).join(', ') + ' ';
    } else {
      description += `on ${days[parseInt(dow)]} `;
    }
  }
  
  return description;
}
        </script>

{% endblock %}
